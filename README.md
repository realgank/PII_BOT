# PII BOT

PII BOT — Discord-бот для управления планетарными установками (POS), складом ресурсов и напоминаниями о сдаче материалов. Он хранит данные в SQLite-базе `planets.db`, автоматически распределяет планеты под POS и ведёт статистику по сдачам ресурсов.

## Быстрый старт

1. Установите зависимости (Python 3.10+ и библиотека `discord.py`).
2. Скопируйте файл базы данных `planets.db` в рабочую директорию бота (или укажите путь через переменную окружения `DB_PATH`).
3. Укажите токен Discord-бота в константе `DISCORD_TOKEN` файла `PII_BOT.py`.
4. Запустите бота: `python PII_BOT.py`.

## Автоматическая установка на Ubuntu

В репозитории добавлен скрипт `scripts/install.sh`, который автоматизирует развёртывание бота на сервере Ubuntu.

```
sudo ./scripts/install.sh --repo https://github.com/<org>/PII_BOT.git \
     --branch main \
     --dir /opt/pii_bot \
     --data /var/lib/pii_bot
```

Скрипт:

- устанавливает необходимые пакеты (`git`, `python3`, `python3-venv`), если их нет в системе;
- клонирует (или обновляет) код из GitHub в указанный каталог;
- создаёт виртуальное окружение и ставит зависимости из `requirements.txt`;
- копирует файл базы данных `planets.db` в каталог данных только если он отсутствует (существующая база не перезаписывается).

После установки запускайте бота с указанием переменной окружения `DB_PATH`, например:

```
DB_PATH=/var/lib/pii_bot/planets.db /opt/pii_bot/.venv/bin/python PII_BOT.py
```

### Переменные окружения

| Переменная | Назначение | Значение по умолчанию |
| --- | --- | --- |
| `DB_PATH` | Путь к файлу базы данных SQLite | `planets.db` |
| `LOG_DIR` | Каталог для файлов логов | `logs` |
| `LOG_LEVEL` | Уровень логирования (`DEBUG`, `INFO`, …) | `INFO` |
| `DEFAULT_SLOTS` | Слоты планет для POS по умолчанию | `10` |
| `DEFAULT_DRILLS` | Количество буров на планету по умолчанию | `22` |
| `DEFAULT_HOURS` | Горизонт прогноза добычи для расчётов | `168` |
| `DEFAULT_BETA` | Коэффициент достоверности добычи | `0.85` |
| `RES_REMINDER_DELAY_HOURS` | Через сколько часов напомнить повторно | `24` |
| `RES_REMINDER_CHECK_SECONDS` | Как часто проверять напоминания | `3600` |

## Команды

Ниже перечислены slash-команды, которыми управляет бот. Если не указано иное, команды доступны на сервере (в личных сообщениях они не работают).

### Настройки `/posdefaults`

Позволяют хранить значения по умолчанию для команд, связанных с POS. Все ответы приходят личным сообщением (ephemeral).

- `/posdefaults setguild slots:<число> drills:<число>` — задаёт стандартные значения слотов и буров для всего сервера. Требуются права администратора.
- `/posdefaults set slots:<число> drills:<число>` — сохраняет личные значения пользователя для текущего сервера.
- `/posdefaults clear` — удаляет персональные значения и возвращает использование серверных или дефолтных из переменных окружения.
- `/posdefaults show` — показывает актуальные значения (учитывает приоритет: личные → серверные → глобальные).

### Управление целями и складом

#### `/setneed`
- **Параметры:** `resource` — название ресурса (есть автодополнение), `amount` — целевой объём в units.
- **Что делает:** добавляет или обновляет запись в целевой таблице `guild_needs_row` для сервера.

#### `/clearneeds`
- **Что делает:** очищает все целевые объёмы сервера.
- **Ответ:** сообщает количество удалённых записей.

#### `/eta`
- **Параметры:** `resource` (опционально — конкретный ресурс), `limit` — максимальное число строк в ответе.
- **Что делает:** рассчитывает время выполнения целей с учётом текущего склада (`/have`) и активной добычи.
- **Ответ:** публичное сообщение со списком целей и оценкой ETA.

#### `/have`
Управление складом гильдии.
- **Параметры:** `action` (`import`, `show`, `clear`), `data` — таблица ресурсов для импорта.
- **import:** ожидает TSV/CSV или однострочный список. Обновляет склад и сохраняет цены из столбца оценки (если есть).
- **show:** выводит до 50 позиций склада.
- **clear:** полностью очищает склад.

#### `/isk`
Работа с ценами ресурсов (ISK за единицу).
- **Параметры:** `action` (`set`, `show`, `import`), `resource`, `price`, `csv_prices`.
- **set:** устанавливает цену для одного ресурса.
- **show:** выводит цену конкретного ресурса либо весь список.
- **import:** принимает CSV со строками `resource,price` и массово обновляет цены.

### Управление POS

#### `/addpos`
- **Параметры:** `name` — имя POS, `system` — система (есть автодополнение), `slots` и `drills` (опционально, по умолчанию берутся из `/posdefaults`).
- **Что делает:** создаёт или обновляет POS пользователя, автоматически распределяя планеты и буры под цели сервера.
- **Особенности:** если POS уже принадлежит другому пользователю, удалить/обновить его может только владелец или администратор.

#### `/refreshpos`
- **Доступ:** только администраторы.
- **Что делает:** удаляет все назначения планет для POS на сервере и рассылает владельцам кнопки в личные сообщения для обновления.

#### `/delpos`
- **Параметры:** `pos_id` (опционально). Если ID не указан, бот пришлёт список доступных POS.
- **Доступ:** владелец POS или администратор.
- **Что делает:** удаляет выбранный POS и связанные планеты.

#### `/delallpos`
- **Доступ:** только администраторы.
- **Что делает:** полностью очищает список POS сервера.

#### `/mypos`
- **Что делает:** показывает пользователю его POS на сервере с датами создания и обновления.

#### `/posstats`
- **Что делает:** выводит общее количество POS на сервере и топ по владельцам. Результат виден всем в канале.

#### `/myassigns`
- **Параметры:** `pos_id` (опционально для фильтрации).
- **Что делает:** перечисляет планеты и буры, назначенные пользователю, с расчётом совокупной добычи.

#### `/userpos`
- **Параметры:** `user` — выбранный участник.
- **Что делает:** показывает POS указанного пользователя. Ответ публикуется в канале.

### Напоминания `/resping`

Группа команд для контроля сдачи ресурсов. Большинство ответов отправляются приватно (ephemeral), кроме создания уведомления.

- `/resping ping text:<текст> role:<роль?> mention_everyone:<bool?>` — создаёт embed-сообщение с кнопкой **Сдал** и заводит учёт сдач. Требуются права администратора. Бот проверяет права на отправку сообщений, embeds и упоминания ролей/`@everyone`. Всем владельцам активных POS приходит личное сообщение с назначенными ресурсами.
- `/resping submit data:<таблица?>` — фиксирует сдачу пользователя. Таблицу можно вставлять как TSV/CSV или свободный текст; команда умеет определять активное напоминание по ветке или последнему пингу.
- `/resping stats days:<число?> ping_id:<ID?>` — выводит сводку по отметкам: активные пользователи и напоминания, фильтруя последние `days` дней (по умолчанию 7). Можно ограничить конкретным напоминанием.
- `/resping audit days:<число?> tolerance:<проценты?>` — только для администраторов. Сравнивает ожидаемые объёмы добычи с фактическими сдачами между отметками и отмечает просадки/перевыполнения.

### Обслуживание бота

- `/updatebot branch:<ветка?> reinstall_deps:<true/false?>` — запускает обновление кода бота из GitHub прямо с сервера, где он запущен. Команда доступна только администраторам, выводит журнал выполнения и не перезаписывает `planets.db`. Параметр `branch` позволяет указать ветку, а `reinstall_deps=true` — переустановить зависимости из `requirements.txt`.

## Форматы таблиц для импорта

Команды `/have import` и `/resping submit` принимают данные в одном из форматов:

- TSV/CSV с заголовком или без него. Колонки определяются автоматически (название, количество, итоговая стоимость).
- Однострочный формат из Discord с колонками `[ID?] Название Количество [Оценка]`.

При импорте бот учитывает только валидные строки, отрицательные количества игнорируются, а оценочная стоимость переводится в цену за единицу.

## Дополнительно

- Бот автоматически создаёт каталог `logs` и записывает в него файлы логов.
- Цикл напоминаний о сдаче ресурсов (`RES_REMINDER_CHECK_SECONDS`) регулярно проверяет просроченные отметки и дублирует уведомления в ветках.
- Для расчёта ETA и аудита используются данные о добыче POS и склада; корректность расчётов зависит от актуальности базы `planets.db`.

